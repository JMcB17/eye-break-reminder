<script type="text/javascript">
    var sks_ece_pollInterval = 20 * 1000 * 60;
    var sks_ece_timer;
    var sks_ece_lastRun = new Date();
    function sks_ece_updatePollInterval() {
        try {
            if (localStorage.getItem('sks_ece_duration') != null) {
                if (parseInt(localStorage.getItem('sks_ece_duration')) == 0) return;
                sks_ece_pollInterval = parseInt(localStorage.getItem('sks_ece_duration')) * 1000 * 60;
                if (sks_ece_pollInterval == NaN)
                    sks_ece_pollInterval = 20 * 1000 * 60;
            }
            //sks_ece_pollInterval = 7500;//demo
        }
        catch (Exdf) {
        }
    }
    function sks_ece_stopTimer() {
        try {
            if (sks_ece_timer)
                clearTimeout(sks_ece_timer);
        }
        catch (Excf) {
            console.log(Excf.message);
        }
    }
    function sks_ece_initiateTimer() {
        sks_ece_lastRun = new Date();
        sks_ece_timer = setTimeout(sks_ece_doProcess, sks_ece_pollInterval);
    }
    function sks_ece_OpenUrl(sks_ece_url, check4page) {
        try {
            chrome.windows.getAll({}, function (windows) {
                if (windows.length > 0) {
                    if (check4page) {
                        chrome.tabs.getSelected(null, function (tb) {
                            if (tb.url.indexOf('chrome:') > -1 && tb.url.indexOf('newtab') > -1) {
                                chrome.tabs.update(tb.id, {
                                    url: sks_ece_url,
                                    selected: true
                                }, function (tb) { console.log(tb); });
                            }
                            else {
                                chrome.tabs.create({
                                    url: sks_ece_url,
                                    selected: true
                                }, function (tb) {
                                });
                            }
                        });
                    }
                    else {
                        chrome.tabs.create({
                            url: sks_ece_url,
                            selected: true
                        }, function (tb) {
                        });
                    }
                }
                else {
                    chrome.windows.create({
                        url: sks_ece_url,
                        focused: true
                    }, function (wind) {
                    });
                }
            });

        }
        catch (ExECE) {
            console.log(ExECE.message);
        }
    }
    function sks_ece_doProcess() {
        try {
            sks_ece_lastRun = new Date();
            if (localStorage.getItem('sks_ece_enabled') != null) {
                if (localStorage.getItem('sks_ece_enabled') == "1") {
                    if (localStorage.getItem('sks_ece_duration') != null) {
                        if (parseInt(localStorage.getItem('sks_ece_duration')) > 0) {
                            //show noti
                            if (localStorage.getItem('sks_ece_noti') != null) {
                                if (localStorage.getItem('sks_ece_noti') == "1")
                                    sks_ece_ShowNoti(localStorage.getItem('sks_ece_message'));
                            }
                            //show page
                            if (localStorage.getItem('sks_ece_page') != null) {
                                if (localStorage.getItem('sks_ece_page') == "1")
                                    sks_ece_OpenUrl("unreads.html", false);

                            }
                            //play sound
                            if (localStorage.getItem('sks_ece_snd') != null) {
                                sks_ece_playSound(localStorage.getItem('sks_ece_snd').toString());
                            }
                            //blink
                            if (localStorage.getItem('sks_ece_blink') != null) {
                                if (localStorage.getItem('sks_ece_blink').toString() == "1") 
                                    sks_ece_blink(1);
                            }
                        }
                    }
                }
            }
        }
        catch (ExEce) {
            console.log(ExEce.message);
        }
        sks_ece_stopTimer(); sks_ece_initiateTimer();
    }    
    function sks_ece_blink(arg) {
        try {
            var icon = (arg % 2) == 1 ? "icon_blue.png" : "icon.png";
            chrome.browserAction.setIcon({ path: icon });
            if (arg < 10) setTimeout(function() { sks_ece_blink(arg + 1) }, 500);
        }
        catch (ExECE) {
            console.log(ExECE.message);
        }
    }
    function sks_ece_ShowNoti(customMessage) {
        try {
            var notify = null;
            if (customMessage!=null) {
                if (customMessage=="")
                    notify = webkitNotifications.createNotification('icon_48.png', "Take a break!", "Blink your eyes, Move them around and look at a distant object for 20 seconds. Click here for more exercises.");
                else
                    notify = webkitNotifications.createNotification('icon_48.png', (customMessage == "" ? "Take a break!" : customMessage), "");
            }
            else {
                notify = webkitNotifications.createNotification('icon_48.png', "Take a break!", "Blink your eyes, Move them around and look at a distant object for 20 seconds. Click here for more information.");
            }
            if (localStorage.getItem('sks_ece_closemessdelay') != null) {
                if (parseInt(localStorage.getItem('sks_ece_closemessdelay'))>0)
                    notify.onshow = notify.ondisplay = function() { setTimeout(function() { notify.cancel(); }, parseInt(localStorage.getItem('sks_ece_closemessdelay'))*1000); }
            }
            //notify.onshow = notify.ondisplay = function() { setTimeout(function() { notify.cancel(); }, 4000); }//demo
            notify.onclick = function () {
                sks_ece_OpenUrl("unreads.html", false);
                notify.cancel();
            };
            notify.show();
        }
        catch (ExNoti) {
            console.log(ExNoti.message);
        }
    }
    function sks_ece_playSound(fileName) {
        try {
            if (!fileName) return;
            if (fileName != "") {
                fileName = "snds/" + fileName + ".mp3"
                var audio = new Audio(fileName);
                audio.play();
            }
        }
        catch (Exreded) {
        }
    }
    function sks_ece_requestBackground(true2grand) {
        if (true2grand) {
            chrome.permissions.request({
                permissions: ['background']
            }, function (granted) {
                // The callback argument will be true if the user granted the permissions.
                if (granted) {
                    localStorage.setItem('sks_ece_bg', "1");
                } else {
                    //localStorage.setItem('sks_ece_bg',"0");
                }
            });
        }
        else {
            chrome.permissions.remove({
                permissions: ['background']
            }, function (removed) {
                if (removed) {
                    // The permissions have been removed.
                    localStorage.setItem('sks_ece_bg', "0");
                } else {
                    // The permissions have not been removed (e.g., you tried to remove
                    // required permissions).
                }
            });
        }
    }
    function sks_ece_timeRemain() {
        var ret = -1;
        try {
            if (localStorage.getItem('sks_ece_duration') != null) {
                if (parseInt(localStorage.getItem('sks_ece_duration')) > 0) {
                    var current = new Date();
                    var span = current - sks_ece_lastRun;
                    //ret = Math.floor(span / 1000 / 60);
                    ret = Math.floor(span / 1000);
                    //ret = parseInt(localStorage.getItem('sks_ece_duration')) - ret;
                    ret = (parseInt(localStorage.getItem('sks_ece_duration')) * 60) - ret;
                }
            }
        }
        catch (ExECe) { }
        return ret;
    }
    chrome.extension.onRequest.addListener(
function (request, sender, sendResponse) {
    if (request.sksmode == "updateinterval") {
        sks_ece_updatePollInterval();
        sks_ece_stopTimer(); sks_ece_initiateTimer();
        sendResponse({});
    }
    else sendResponse({}); // snub them.
});
//localStorage.setItem('sks_ece_duration', 1);
    sks_ece_updatePollInterval();
    sks_ece_initiateTimer();    
</script>
